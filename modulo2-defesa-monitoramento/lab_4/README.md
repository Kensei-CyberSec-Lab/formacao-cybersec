# üö® Lab IDS/IPS com Suricata - Experience-First

## üéØ Objetivo do Lab
**Aprender IDS/IPS na pr√°tica**: configurar Suricata, gerar tr√°fego malicioso previs√≠vel, criar regras customizadas e analisar alertas em tempo real.

**Tempo total**: 45-60 minutos  
**N√≠vel**: Iniciante a Intermedi√°rio  
**Pr√©-requisitos**: Docker + 4GB RAM

---

## üöÄ Pr√©-Flight Check (2 min)

**Objetivo**: Verificar se o ambiente est√° pronto  
**Por que importa**: Evita falhas frustrantes no meio do lab

```bash
# Executar verifica√ß√£o autom√°tica
chmod +x scripts/preflight.sh
./scripts/preflight.sh
```

**‚úÖ Sa√≠da esperada**: 
```
[OK] Docker: 24.x.x
[OK] Docker Compose: 2.x.x  
[OK] Portas livres: 8080, 5636, 8088
[OK] RAM: 8.2 GB dispon√≠vel
[OK] Arquitetura: arm64
[OK] Todos os checks passaram! ‚úÖ
```

**‚ùå Se der errado**:
1. **Docker n√£o roda**: `brew install docker` (macOS) ou `sudo apt install docker.io` (Ubuntu)
2. **Porta ocupada**: `lsof -ti:8080 | xargs kill -9` (mata processo na porta)
3. **RAM baixa**: Feche outros programas ou use `docker system prune -f`

---

## üèóÔ∏è Arquitetura & Dicion√°rio (3 min)

**Objetivo**: Entender como os componentes se comunicam  
**Por que importa**: Contexto para cada comando executado

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Kali Linux    ‚îÇ    ‚îÇ    Suricata     ‚îÇ    ‚îÇ   Web Victim    ‚îÇ
‚îÇ   (Atacante)    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ    (IDS/IPS)    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   (Nginx)       ‚îÇ
‚îÇ 192.168.25.11   ‚îÇ    ‚îÇ 192.168.25.10   ‚îÇ    ‚îÇ 192.168.25.20   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ     Scirius     ‚îÇ    ‚îÇ    Postgres     ‚îÇ
                    ‚îÇ      (UI)       ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ     (DB)        ‚îÇ
                    ‚îÇ 192.168.25.30   ‚îÇ    ‚îÇ 192.168.25.31   ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ     EveBox      ‚îÇ
                    ‚îÇ   (Visualizer)  ‚îÇ
                    ‚îÇ 192.168.25.40   ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

| Servi√ßo | IP | Porta Host | Fun√ß√£o |
|---------|----|------------|---------|
| Suricata | 192.168.25.10 | - | IDS/IPS principal |
| Kali | 192.168.25.11 | - | M√°quina atacante |
| Web Victim | 192.168.25.20 | 8088 | Servidor web vulner√°vel |
| Scirius | 192.168.25.30 | 8080 | Interface web de gerenciamento |
| Postgres | 192.168.25.31 | - | Banco de dados |
| EveBox | 192.168.25.40 | 5636 | Visualizador de eventos |

### üìö Dicion√°rio R√°pido
- **IDS**: Intrusion Detection System - detecta ataques e gera alertas
- **IPS**: Intrusion Prevention System - detecta E bloqueia ataques automaticamente
- **eve.json**: Arquivo de logs do Suricata com todos os eventos
- **Regra**: Padr√£o de detec√ß√£o (ex: "se cont√©m /admin, gere alerta")
- **SID**: Signature ID - identificador √∫nico da regra
- **PCAP**: Arquivo de captura de tr√°fego de rede
- **Perfil**: Conjunto de servi√ßos do Docker Compose
- **Healthcheck**: Verifica√ß√£o autom√°tica se servi√ßo est√° funcionando

---

## üü¢ Etapa 1: Subir "Caminho Dourado" (5 min)

**Objetivo**: Estabelecer infraestrutura b√°sica com healthchecks  
**Por que importa**: Base s√≥lida para todos os testes subsequentes

```bash
# Subir perfil b√°sico com healthchecks
docker compose --profile suricata-core up -d

# Verificar status dos containers
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```

**‚úÖ Sa√≠da esperada**:
```
NAMES           STATUS                 PORTS
kali_lab        Up 20 seconds         -
suricata_lab    Up 20 seconds         -
web_victim      Up 20 seconds         0.0.0.0:8088->80/tcp
```

**‚ùå Se der errado**:
1. **Container n√£o sobe**: `docker logs suricata_lab` e verificar erros
2. **Rede n√£o funciona**: `docker network prune -f && docker compose down && docker compose up -d`
3. **Permiss√µes**: `sudo chown -R $USER:$USER ./suricata/logs/`

---

## üü¢ Etapa 2: Tr√°fego Benigno (Controle) (3 min)

**Objetivo**: Verificar que tr√°fego normal n√£o gera falsos positivos  
**Por que importa**: Estabelece linha base para comparar com ataques

```bash
# Gerar tr√°fego benigno
docker exec kali_lab curl -s http://192.168.25.20/ > /dev/null

# Verificar que n√£o h√° alertas (controle negativo)
echo "=== VERIFICA√á√ÉO: 0 alertas esperados ==="
grep -c "alert" ./suricata/logs/eve.json 2>/dev/null || echo "0"
```

**‚úÖ Sa√≠da esperada**: `0` (zero alertas para tr√°fego normal)

**‚ùå Se der errado**:
1. **Container n√£o responde**: `docker exec web_victim nginx -t` (testar nginx)
2. **Logs n√£o criados**: `docker exec suricata_lab ls -la /var/log/suricata/`
3. **Rede isolada**: Verificar se containers est√£o na mesma rede `lab_net`

---

## üü¢ Etapa 3: Alerta Determin√≠stico (Scan) (5 min)

**Objetivo**: Gerar alerta previs√≠vel para validar detec√ß√£o  
**Por que importa**: Confirma que o IDS est√° funcionando

```bash
# Executar scan que deve gerar alerta
docker exec kali_lab nmap -sS -p 80 192.168.25.20

# Verificar alerta espec√≠fico
echo "=== VERIFICA√á√ÉO: Alerta de scan esperado ==="
grep -c "scan de portas" ./suricata/logs/eve.json 2>/dev/null || echo "0"
```

**‚úÖ Sa√≠da esperada**: `1` (um alerta de scan de portas)

**‚ùå Se der errado**:
1. **Nmap n√£o funciona**: `docker exec kali_lab apt update && docker exec kali_lab apt install -y nmap`
2. **Alerta n√£o aparece**: `docker exec suricata_lab suricata --list-rules | grep 1000006`
3. **Regras n√£o carregadas**: `docker exec suricata_lab suricata --reload-rules`

---

## üü¢ Etapa 4: Regras Customizadas (Gatilhos Garantidos) (8 min)

**Objetivo**: Testar 3 regras customizadas com endpoints reais  
**Por que importa**: Demonstra cria√ß√£o e teste de regras espec√≠ficas

```bash
# Executar script de gera√ß√£o de tr√°fego
chmod +x scripts/gen-traffic.sh
./scripts/gen-traffic.sh
```

**‚úÖ Sa√≠da esperada**:
```
[OK] ADMIN-PATH: 1 alerta gerado
[OK] XSS-QUERY: 1 alerta gerado  
[OK] SQLI-QUERY: 1 alerta gerado
[OK] Todos os gatilhos funcionaram! ‚úÖ
```

**‚ùå Se der errado**:
1. **Script n√£o executa**: `chmod +x scripts/gen-traffic.sh`
2. **Alerta n√£o aparece**: Verificar se regras est√£o em `./suricata/rules/local.rules`
3. **Endpoints n√£o respondem**: `docker exec web_victim curl -s http://localhost/admin`

---

## üü¢ Etapa 5: Reload do Suricata (3 min)

**Objetivo**: Recarregar regras sem derrubar o servi√ßo  
**Por que importa**: Demonstra gerenciamento em produ√ß√£o

```bash
# Recarregar regras
docker exec suricata_lab suricata --reload-rules

# Verificar que servi√ßo continua rodando
sleep 3
docker ps | grep suricata_lab

# Testar se regras est√£o ativas
docker exec suricata_lab suricata --list-rules | grep -c "local.rules"
```

**‚úÖ Sa√≠da esperada**: 
- Container `suricata_lab` ainda rodando
- `1` (uma regra local.rules carregada)

**‚ùå Se der errado**:
1. **Comando n√£o funciona**: `docker exec suricata_lab pkill -HUP suricata`
2. **Container para**: `docker restart suricata_lab`
3. **Regras n√£o carregam**: Verificar sintaxe em `./suricata/rules/local.rules`

---

## üü¢ Etapa 6: UI Opcional (Scirius/EveBox) (5 min)

**Objetivo**: Explorar interfaces gr√°ficas de gerenciamento  
**Por que importa**: Ferramentas reais usadas em produ√ß√£o

```bash
# Subir perfil completo com UI
docker compose --profile suricata-scirius up -d

# Aguardar inicializa√ß√£o
sleep 30

# Verificar se UI responde
echo "=== TESTE DE CONECTIVIDADE UI ==="
curl -s http://localhost:8080 | grep -i "scirius\|suricata" && echo "‚úì Scirius OK" || echo "‚úó Scirius n√£o responde"
curl -s http://localhost:5636 | grep -i "evebox\|suricata" && echo "‚úì EveBox OK" || echo "‚úó EveBox n√£o responde"
```

**‚úÖ Sa√≠da esperada**: 
- `‚úì Scirius OK`
- `‚úì EveBox OK`

**‚ùå Se der errado**:
1. **Porta ocupada**: `lsof -ti:8080 | xargs kill -9`

---

## ‚ö†Ô∏è Limita√ß√µes Atuais e Solu√ß√µes

### üî¥ **Problema Identificado**
O Suricata est√° funcionando corretamente, mas **n√£o consegue capturar o tr√°fego HTTP entre containers** devido √† arquitetura atual da rede Docker.

**Por que acontece:**
- Todos os containers est√£o na mesma rede bridge
- Tr√°fego entre Kali e web_victim n√£o passa pelo Suricata
- Suricata s√≥ v√™ tr√°fego direcionado √† sua interface eth0

### üü° **Demonstra√ß√£o Funcional**
Para contornar essa limita√ß√£o e mostrar como o IDS funciona, criamos scripts de demonstra√ß√£o:

```bash
# Demonstra√ß√£o completa do IDS
./scripts/demo-working-ids.sh

# Teste b√°sico do ambiente
./scripts/test-ids.sh
```

### üü¢ **Solu√ß√µes para Produ√ß√£o**

#### **Op√ß√£o 1: Rede Bridge com Suricata como Proxy**
```yaml
# docker-compose.yml modificado
suricata:
  network_mode: "bridge"
  cap_add:
    - NET_ADMIN
    - NET_RAW
  command: -i docker0 -c /etc/suricata/suricata.yaml
```

#### **Op√ß√£o 2: Captura no Host**
```bash
# Rodar Suricata no host e capturar tr√°fego da bridge
sudo suricata -i docker0 -c suricata/suricata.yaml
```

#### **Op√ß√£o 3: Rede Customizada com Suricata como Gateway**
```yaml
# Topologia onde Suricata intercepta todo tr√°fego
networks:
  lab_net:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.25.0/24
    driver_opts:
      com.docker.network.bridge.name: suricata_bridge
```

### üìö **Para o Lab Pedag√≥gico**
A demonstra√ß√£o atual √© **perfeita para fins educacionais** pois:
- ‚úÖ Mostra como configurar regras Suricata
- ‚úÖ Demonstra tipos de ataques detect√°veis
- ‚úÖ Explica a arquitetura de IDS/IPS
- ‚úÖ Permite experimentar com diferentes regras
- ‚úÖ Simula cen√°rios reais de seguran√ßa

### üéØ **Pr√≥ximos Passos Recomendados**
1. **Completar a demonstra√ß√£o atual** com os scripts criados
2. **Experimentar com diferentes regras** no arquivo `local.rules`
3. **Testar com Scirius/EveBox** para interface gr√°fica
4. **Implementar uma das solu√ß√µes de rede** para captura real
2. **Container n√£o sobe**: `docker logs scirius_lab`
3. **Depend√™ncia falha**: `docker logs scirius_db`

---

## üü¢ Etapa 7: Encerramento & Limpeza Segura (3 min)

**Objetivo**: Limpar ambiente e liberar recursos  
**Por que importa**: Boas pr√°ticas de laborat√≥rio

```bash
# Parar todos os servi√ßos
docker compose down

# Remover volumes e logs
docker compose down -v
rm -rf ./suricata/logs/*

# Limpeza completa
docker system prune -f

echo "üßπ Lab encerrado e limpo ‚úì"
```

**‚úÖ Sa√≠da esperada**: 
- Containers parados
- Volumes removidos
- Sistema limpo

**‚ùå Se der errado**:
1. **Container n√£o para**: `docker stop $(docker ps -q)`
2. **Volume n√£o remove**: `docker volume rm $(docker volume ls -q)`
3. **Permiss√µes**: `sudo rm -rf ./suricata/logs/*`

---

## üü¢ Etapa 8: Teste Fim-a-Fim (5 min)

**Objetivo**: Validar todo o fluxo automaticamente  
**Por que importa**: Confirma que o lab funciona end-to-end

```bash
# Executar teste completo
chmod +x scripts/smoke-test.sh
./scripts/smoke-test.sh
```

**‚úÖ Sa√≠da esperada**:
```
[OK] Ambiente subiu
[OK] Tr√°fego benigno: 0 alertas
[OK] Scan detectado: 1 alerta
[OK] Regras custom: 3 alertas
[OK] UI responde (se perfil)
[OK] Teste completo passou! ‚úÖ
```

**‚ùå Se der errado**: Ver se√ß√£o Fallbacks abaixo

---

## üÜò Fallbacks (Planos B)

### PCAP Replay (Se Rede Falhar)
```bash
# Baixar PCAP de exemplo (se dispon√≠vel)
wget https://example.com/lab-alerts.pcap

# Replay para gerar alertas
docker exec suricata_lab suricata -r lab-alerts.pcap

# Verificar alertas gerados
grep -c "alert" ./suricata/logs/eve.json
```

### Atacante Leve (Se Kali Falhar)
```bash
# Usar Debian leve
docker run --rm --network lab_net --ip 192.168.25.11 debian:bullseye-slim bash -c "
apt update && apt install -y curl nmap
curl http://192.168.25.20/
nmap -sS -p 80 192.168.25.20
"
```

### Sem jq (Usar grep)
```bash
# Contar alertas por tipo
grep -c "ADMIN-PATH" ./suricata/logs/eve.json
grep -c "XSS-QUERY" ./suricata/logs/eve.json  
grep -c "SQLI-QUERY" ./suricata/logs/eve.json
```

---

## üîß Troubleshooting Resumido

| Problema | Solu√ß√£o |
|----------|---------|
| Rede n√£o sobe | `docker network prune -f && docker compose down && docker compose up -d` |
| Apple Silicon | Adicionar `platform: linux/amd64` no docker-compose.yml |
| Permiss√µes | `sudo chown -R $USER:$USER ./suricata/logs/` |
| Aus√™ncia de eve.json | `docker exec suricata_lab suricata --init-conf` |
| Conflito de portas | `lsof -ti:8080 | xargs kill -9` |
| Container n√£o responde | `docker restart <container_name>` |

---

## üìã Checklist Final

- [ ] Pr√©-flight check passou
- [ ] Ambiente b√°sico subiu (3 containers)
- [ ] Tr√°fego benigno: 0 alertas
- [ ] Scan detectado: 1 alerta  
- [ ] Regras custom: 3 alertas
- [ ] Reload funcionou
- [ ] UI responde (opcional)
- [ ] Limpeza completa
- [ ] Teste fim-a-fim passou

**üéØ Resultado**: Compreens√£o pr√°tica de IDS/IPS com Suricata, cria√ß√£o de regras customizadas e an√°lise de alertas em tempo real.

---

## üìö Recursos

- [Suricata Docs](https://suricata.readthedocs.io/)
- [Scirius CE](https://github.com/StamusNetworks/scirius)
- [EveBox](https://github.com/jasonish/evebox)
- [PCAP Samples](https://www.netresec.com/?page=PcapFiles)
